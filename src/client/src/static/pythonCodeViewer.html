<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generated Python Code</title>
  <link rel="stylesheet" href="./pythonCodeViewer.css">
  <!-- Prism.js for syntax highlighting -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
</head>
<body>
  <div class="header">
    <div class="title">Generated Python Code</div>
    <div style="display: flex; align-items: center; gap: 10px;">
      <span class="readonly-badge">Read Only</span>
      <button class="close-btn" onclick="closeWindow()">Close</button>
    </div>
  </div>

  <div class="code-container">
    <div class="update-indicator" id="updateIndicator">Updated</div>
    <pre class="line-numbers"><code class="language-python" id="codeContent">No blocks in script yet. Add some blocks to see the generated Python code.</code></pre>
  </div>

  <script>
    // Listen for code updates from the main process
    window.addEventListener('codeUpdate', (event) => {
      updateCode(event.detail);
    });

    function updateCode(code) {
      const codeContent = document.getElementById('codeContent');
      const updateIndicator = document.getElementById('updateIndicator');

      try {
        if (!code || code.trim() === '') {
          codeContent.textContent = 'No blocks in script yet. Add some blocks to see the generated Python code.';
          codeContent.className = 'empty-state';
        } else {
          // Set the code content
          codeContent.textContent = code;
          codeContent.className = 'language-python';
          
          // Apply Prism.js highlighting
          if (window.Prism && window.Prism.languages && window.Prism.languages.python) {
            // Force re-highlighting
            delete codeContent.dataset.highlighted;
            Prism.highlightElement(codeContent);
          } else {
            console.warn('Prism or Python language not loaded');
          }
        }

        // Show update indicator briefly
        if (updateIndicator) {
          updateIndicator.classList.add('show');
          setTimeout(() => {
            updateIndicator.classList.remove('show');
          }, 1500);
        }
      } catch (error) {
        console.error('Error updating code:', error);
        codeContent.textContent = 'Error displaying code. Please try refreshing.';
        codeContent.className = 'error-state';
      }
    }

    function closeWindow() {
      window.close();
    }

    // Initialize when DOM and scripts are ready
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Python code viewer ready');
      console.log('Prism available:', !!window.Prism);
      console.log('Python language available:', !!(window.Prism && window.Prism.languages && window.Prism.languages.python));
      
      // Force Prism manual mode for better control
      if (window.Prism) {
        window.Prism.manual = true;
      }
    });
  </script>
</body>
</html>
